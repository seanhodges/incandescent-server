AWSTemplateFormatVersion: 2010-09-09
Description: >-
  Server for the Incandescent app

# Transform section specifies one or more macros that AWS CloudFormation uses to process your template
# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/transform-section-structure.html
Transform: AWS::Serverless-2016-10-31

# Shared configuration for all resources, more in
# https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
  Function:
    PermissionsBoundary: !Sub 'arn:${AWS::Partition}:iam::${AWS::AccountId}:policy/${AppId}-${AWS::Region}-PermissionsBoundary'

Parameters:
  AppId:
    Type: String

Resources:
  IncandescentLambdaBasicExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          Effect: Allow
          Principal:
            Service: lambda.amazonaws.com
          Action: 
            - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaSQSQueueExecutionRole
      Policies:
        - PolicyName: IncandescentLambdaPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                - dynamodb:BatchGetItem
                - dynamodb:GetItem
                - dynamodb:Query
                - dynamodb:BatchWriteItem
                - dynamodb:PutItem
                - dynamodb:UpdateItem
                Resource: '*'
  
  ApiGatewayRole:
      Type: AWS::IAM::Role
      Properties:
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            Effect: Allow
            Principal:
              Service: apigateway.amazonaws.com
            Action: 
              - sts:AssumeRole
        Path: /
        ManagedPolicyArns:
          - arn:aws:iam::aws:policy/service-role/AmazonAPIGatewayPushToCloudWatchLogs
        Policies:
          - PolicyName: IncandescentApiGatewayPolicy
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action:
                    - dynamodb:BatchGetItem
                    - dynamodb:GetItem
                    - dynamodb:Query
                  Resource: '*'

  CloudWatchAccount:
    Type: AWS::ApiGateway::Account
    Properties: 
      CloudWatchRoleArn: !GetAtt ApiGatewayRole.Arn

  ApiAccessLogGroup:
    Type: AWS::Logs::LogGroup

  PythonRestClientLambdaLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      ContentUri: ./src/layers/restClientLambdaLayer/restClientLambdaLayer.zip
      CompatibleRuntimes:
        - python3.9

  ApiGateway:
    Type: AWS::Serverless::Api
    DependsOn: CloudWatchAccount
    Properties:
      DefinitionBody:
        'Fn::Transform':
          Name: 'AWS::Include'
          Parameters:
            Location: 'apigateway-openapi.yaml'
      Mode: overwrite
      StageName: prod
      EndpointConfiguration: REGIONAL
      Auth:
        ApiKeyRequired: true
        UsagePlan:
          UsagePlanName: Basic
          CreateUsagePlan: PER_API
          Quota:
            Limit: 10000
            Period: DAY
          Throttle:
            BurstLimit: 250
            RateLimit: 500
      AccessLogSetting:
        DestinationArn: !Sub ${ApiAccessLogGroup.Arn}
        Format: "{ 'requestId':'$context.requestId', 'ip': '$context.identity.sourceIp', 'caller':'$context.identity.caller', 'user':'$context.identity.user','requestTime':'$context.requestTime', 'xrayTraceId':'$context.xrayTraceId', 'wafResponseCode':'$context.wafResponseCode', 'httpMethod':'$context.httpMethod','resourcePath':'$context.resourcePath', 'status':'$context.status','protocol':'$context.protocol', 'responseLength':'$context.responseLength' }"

  SendOperationFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./src/handlers/sendOperation
      Handler: send-operation.lambda_handler
      Runtime: python3.9
      Layers:
        - !Ref PythonRestClientLambdaLayer
      Role: !GetAtt IncandescentLambdaBasicExecutionRole.Arn

  UpsertDeviceFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./src/handlers/upsertDevice
      Handler: upsert-device.lambda_handler
      Runtime: python3.9
      Role: !GetAtt IncandescentLambdaBasicExecutionRole.Arn
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt DeviceReceivedQueue.Arn
            BatchSize: 10
            MaximumBatchingWindowInSeconds: 10

  DeviceReceivedQueue:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 345600 # 4 days
      VisibilityTimeout: 10 # 10 seconds
      RedrivePolicy: 
        deadLetterTargetArn: !GetAtt DeviceNotProcessedQueue.Arn
        maxReceiveCount: 5
  
  DeviceNotProcessedQueue:
    Type: AWS::SQS::Queue

  DeviceTable:
    Type: AWS::DynamoDB::Table
    Properties: 
      AttributeDefinitions: 
        - AttributeName: userId # "user01"
          AttributeType: S
        - AttributeName: deviceRef # "home/living-room/lights/side-lamp"
          AttributeType: S
        - AttributeName: featureSetId
          AttributeType: S
        - AttributeName: deviceId
          AttributeType: S
      KeySchema:
        - AttributeName: userId
          KeyType: HASH
        - AttributeName: deviceRef
          KeyType: RANGE
      ProvisionedThroughput: 
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
      LocalSecondaryIndexes:
          - IndexName: indexByFeatureSetId
            KeySchema: 
            - AttributeName: userId
              KeyType: HASH
            - AttributeName: featureSetId
              KeyType: RANGE
            Projection: 
              ProjectionType: INCLUDE
              NonKeyAttributes:
              - zoneName
              - zoneId
              - roomName
              - roomId
              - featureSetName
              - deviceName
              - deviceId
              - deviceRef
          - IndexName: indexByDeviceId
            KeySchema: 
            - AttributeName: userId
              KeyType: HASH
            - AttributeName: deviceId
              KeyType: RANGE
            Projection: 
              ProjectionType: INCLUDE
              NonKeyAttributes:
              - zoneName
              - zoneId
              - roomName
              - roomId
              - featureSetName
              - featureSetId
              - deviceName
              - deviceRef

Outputs:
  ServerApi:
    Description: URL for the server API
    Value: !Sub 'https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com'
